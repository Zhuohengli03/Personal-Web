---
import BaseLayout from '../layouts/BaseLayout.astro';
const base = import.meta.env.BASE_URL;
---
<BaseLayout title="留言 | 李卓衡" description="Leave a message - Zhuoheng Li">
  <h1 class="page-title" data-i18n="navGuestbook">留言</h1>
  <p class="guestbook-intro content-zh">欢迎留下你的想法或问候。</p>
  <p class="guestbook-intro content-en">Leave a message or say hi.</p>

  <div class="guestbook-card guestbook-form-wrap">
    <form id="guestbook-form" class="guestbook-form">
      <label class="guestbook-label">
        <span class="content-zh">昵称</span>
        <span class="content-en">Name</span>
        <input type="text" name="name" required maxlength="80" placeholder="Your name" />
      </label>
      <label class="guestbook-label">
        <span class="content-zh">邮箱（选填）</span>
        <span class="content-en">Email (optional)</span>
        <input type="email" name="email" maxlength="120" placeholder="you@example.com" />
      </label>
      <label class="guestbook-label">
        <span class="content-zh">留言内容</span>
        <span class="content-en">Message</span>
        <textarea name="message" required maxlength="2000" rows="4" placeholder="Write something..."></textarea>
      </label>
      <!-- 蜜罐：机器人会填，真人不可见不填 -->
      <label class="guestbook-hp" aria-hidden="true">
        <input type="text" name="website" tabindex="-1" autocomplete="off" />
      </label>
      <button type="submit" id="guestbook-submit-btn" class="guestbook-submit">
        <span class="content-zh">发布</span>
        <span class="content-en">Submit</span>
      </button>
      <p id="guestbook-form-status" class="guestbook-status" aria-live="polite"></p>
    </form>
  </div>

  <div class="guestbook-list-wrap">
    <h2 class="guestbook-list-title content-zh">留言列表</h2>
    <h2 class="guestbook-list-title content-en">Messages</h2>
    <div id="guestbook-list" class="guestbook-list"></div>
    <p id="guestbook-loading" class="guestbook-loading content-zh">加载中…</p>
    <p id="guestbook-loading-en" class="guestbook-loading content-en">Loading…</p>
    <p id="guestbook-empty" class="guestbook-empty content-zh" hidden>暂无留言，来写第一条吧。</p>
    <p id="guestbook-empty-en" class="guestbook-empty content-en" hidden>No messages yet. Be the first!</p>
  </div>

  <p class="page-footer"><a href={base}>← <span data-i18n="navHome">首页</span></a></p>
</BaseLayout>

<script>
  import { getSupabase } from '../lib/supabaseClient';
  import type { GuestbookRow } from '../lib/supabaseClient';

  const form = document.getElementById('guestbook-form') as HTMLFormElement;
  const listEl = document.getElementById('guestbook-list');
  const loadingZh = document.getElementById('guestbook-loading');
  const loadingEn = document.getElementById('guestbook-loading-en');
  const emptyZh = document.getElementById('guestbook-empty');
  const emptyEn = document.getElementById('guestbook-empty-en');
  const statusEl = document.getElementById('guestbook-form-status');

  function setStatus(msg: string, isError: boolean) {
    if (!statusEl) return;
    statusEl.textContent = msg;
    statusEl.dataset.error = isError ? '1' : '';
  }

  function hideLoadings() {
    loadingZh?.setAttribute('hidden', '');
    loadingEn?.setAttribute('hidden', '');
  }

  function renderMessages(rows: GuestbookRow[]) {
    if (!listEl) return;
    hideLoadings();
    if (emptyZh) emptyZh.hidden = rows.length > 0;
    if (emptyEn) emptyEn.hidden = rows.length > 0;
    listEl.innerHTML = rows
      .map((r, i) => {
        const date = new Date(r.created_at).toLocaleDateString(undefined, {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
        const name = escapeHtml(r.name);
        const msg = escapeHtml(r.message);
        const initial = (r.name.trim().charAt(0) || '?').toUpperCase();
        return `<article class="guestbook-card guestbook-item" style="--i:${i}" data-id="${escapeHtml(r.id)}">
          <div class="guestbook-item-avatar" aria-hidden="true">${initial}</div>
          <div class="guestbook-item-body">
            <header class="guestbook-item-header">
              <span class="guestbook-item-name">${name}</span>
              <time class="guestbook-item-time" datetime="${r.created_at}">${date}</time>
            </header>
            <p class="guestbook-item-message">${msg}</p>
          </div>
        </article>`;
      })
      .join('');
  }

  function escapeHtml(s: string): string {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  async function loadMessages() {
    const sb = getSupabase();
    if (!sb) {
      renderMessages([]);
      if (listEl) listEl.innerHTML = '<p class="guestbook-empty content-zh">未配置 Supabase，请设置 PUBLIC_SUPABASE_URL 与 PUBLIC_SUPABASE_ANON_KEY。</p><p class="guestbook-empty content-en">Supabase not configured. Set PUBLIC_SUPABASE_URL and PUBLIC_SUPABASE_ANON_KEY.</p>';
      return;
    }
    const { data, error } = await sb
      .from('guestbook_messages')
      .select('id, name, email, message, created_at')
      .order('created_at', { ascending: false })
      .limit(100);
    if (error) {
      renderMessages([]);
      if (listEl) listEl.innerHTML = '<p class="guestbook-empty">加载失败。</p>';
      return;
    }
    renderMessages((data || []) as GuestbookRow[]);
  }

  const COOLDOWN_SEC = 60;
  let cooldownUntil = 0;
  let submitting = false;

  function setSubmitDisabled(disabled: boolean, label?: 'submit' | 'sending') {
    const btn = document.getElementById('guestbook-submit-btn');
    if (!btn) return;
    (btn as HTMLButtonElement).disabled = disabled;
    if (label) {
      const zh = btn.querySelector('.content-zh') as HTMLElement | null;
      const en = btn.querySelector('.content-en') as HTMLElement | null;
      if (zh) zh.textContent = label === 'submit' ? '发布' : '提交中…';
      if (en) en.textContent = label === 'submit' ? 'Submit' : 'Submitting…';
    }
  }

  function startCooldown() {
    cooldownUntil = Date.now() + COOLDOWN_SEC * 1000;
    const btn = document.getElementById('guestbook-submit-btn');
    if (!btn) return;
    (btn as HTMLButtonElement).disabled = true;
    const zh = btn.querySelector('.content-zh');
    const en = btn.querySelector('.content-en');
    const interval = setInterval(() => {
      const left = Math.ceil((cooldownUntil - Date.now()) / 1000);
      if (left <= 0) {
        clearInterval(interval);
        (btn as HTMLButtonElement).disabled = false;
        if (zh) zh.textContent = '发布';
        if (en) en.textContent = 'Submit';
        return;
      }
      if (zh) zh.textContent = left + ' 秒后再试';
      if (en) en.textContent = left + 's';
    }, 1000);
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (submitting) return;
    const fd = new FormData(form);
    if ((fd.get('website') as string)?.trim()) {
      setStatus('', false);
      return;
    }
    if (Date.now() < cooldownUntil) return;
    const sb = getSupabase();
    if (!sb) {
      setStatus('Supabase 未配置', true);
      return;
    }
    const name = (fd.get('name') as string)?.trim();
    const email = (fd.get('email') as string)?.trim() || null;
    const message = (fd.get('message') as string)?.trim();
    if (!name || !message) return;
    setStatus('', false);
    submitting = true;
    setSubmitDisabled(true, 'sending');
    const sessionId = typeof window !== 'undefined' ? (window as unknown as { __analyticsSessionId__?: string }).__analyticsSessionId__ : null;
    const row: { name: string; email: string | null; message: string; session_id?: string } = { name, email, message };
    if (sessionId) row.session_id = sessionId;
    const { error } = await sb.from('guestbook_messages').insert([row]);
    submitting = false;
    if (error) {
      const msg = error.code === 'P0001' ? (document.documentElement.lang === 'zh' ? '发送太频繁，请稍后再试' : 'Too many messages. Please try again later.') : (error.message || (document.documentElement.lang === 'zh' ? '发布失败' : 'Failed'));
      setStatus(msg, true);
      setSubmitDisabled(false, 'submit');
      return;
    }
    if (sessionId) {
      sb.from('analytics_events').insert([{ session_id: sessionId, event_type: 'guestbook_submit', page_path: (location.pathname.replace(/\/$/, '') || '/'), metadata: {} }]).then(() => {}).catch(() => {});
    }
    setStatus(document.documentElement.lang === 'en' ? 'Submitted!' : '已发布', false);
    form.reset();
    startCooldown();
    await loadMessages();
  });

  loadMessages();
</script>

<style>
  .page-title {
    font-family: var(--font-serif);
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 0 0.5rem;
  }
  .guestbook-intro {
    color: var(--muted);
    font-size: 0.95rem;
    margin: 0 0 1.5rem;
  }
  .guestbook-card {
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    box-shadow: var(--glass-shadow);
  }
  .guestbook-form-wrap {
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  .guestbook-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .guestbook-label {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    font-size: 0.9rem;
    color: var(--muted);
  }
  .guestbook-label input,
  .guestbook-label textarea {
    padding: 0.6rem 0.75rem;
    font-size: 1rem;
    font-family: inherit;
    color: var(--text);
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--glass-border);
    border-radius: calc(var(--radius) - 2px);
  }
  .guestbook-label textarea {
    resize: vertical;
    min-height: 4rem;
  }
  .guestbook-hp {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  .guestbook-submit {
    align-self: flex-start;
    padding: 0.5rem 1.25rem;
    font-size: 0.95rem;
    font-weight: 600;
    color: #fff;
    background: var(--accent);
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
  }
  .guestbook-submit:hover {
    background: var(--accent-hover);
  }
  .guestbook-submit:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }
  .guestbook-status {
    font-size: 0.9rem;
    margin: 0;
  }
  .guestbook-status[data-error="1"] {
    color: #f87171;
  }
  .guestbook-list-title {
    font-family: var(--font-serif);
    font-size: 1.15rem;
    font-weight: 600;
    margin: 0 0 1rem;
  }
  .guestbook-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .guestbook-loading,
  .guestbook-empty {
    color: var(--muted);
    font-size: 0.9rem;
    margin: 0 0 1rem;
  }

  /* 留言卡片：头像 + 内容，错峰入场动画 */
  .guestbook-item {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    padding: 1.25rem 1.5rem;
    border-left: 3px solid rgba(63, 185, 80, 0.4);
    opacity: 0;
    transform: translateY(12px);
    animation: guestbook-item-in 0.4s ease-out forwards;
    animation-delay: calc(0.06s * var(--i, 0));
  }
  @keyframes guestbook-item-in {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .guestbook-item-avatar {
    flex-shrink: 0;
    width: 2.75rem;
    height: 2.75rem;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: #fff;
    font-size: 1.1rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }
  .guestbook-item-body {
    flex: 1;
    min-width: 0;
  }
  .guestbook-item-header {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .guestbook-item-name {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text);
  }
  .guestbook-item-time {
    font-size: 0.8rem;
    color: var(--muted);
  }
  .guestbook-item-message {
    margin: 0;
    font-size: 0.95rem;
    line-height: 1.65;
    color: var(--text);
    white-space: pre-wrap;
    word-break: break-word;
  }
  .guestbook-item:hover {
    border-left-color: var(--accent);
  }
  .page-footer {
    margin-top: 2rem;
    font-size: 0.9rem;
    color: var(--muted);
  }
</style>
