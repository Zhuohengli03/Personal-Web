---
import BaseLayout from '../../layouts/BaseLayout.astro';
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import fs from 'fs';
import path from 'path';
import { hardcodedProjects } from '../../data/hardcodedProjects';

const imageExtensions = new Set(['.jpg', '.jpeg', '.png', '.webp', '.gif']);

function getProjectImages(slug: string): string[] {
  const dir = path.join(process.cwd(), 'public', 'projects', slug);
  try {
    if (!fs.existsSync(dir) || !fs.statSync(dir).isDirectory()) return [];
    const files = fs.readdirSync(dir);
    return files
      .filter((f) => imageExtensions.has(path.extname(f).toLowerCase()) && !f.startsWith('.'))
      .sort();
  } catch {
    return [];
  }
}

function formatBody(text: string): string {
  if (!text.trim()) return '';
  return text
    .trim()
    .split(/\n\n+/)
    .map((p) => `<p>${p.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</p>`)
    .join('');
}

function escapeHtml(code: string): string {
  return code
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

export async function getStaticPaths() {
  const fromMarkdown = await getCollection('projects');
  const markdownPaths = fromMarkdown.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry, hardcoded: null as null },
  }));
  const hardcodedPaths = hardcodedProjects.map((project) => ({
    params: { slug: project.slug },
    props: { entry: null as null, hardcoded: project },
  }));
  return [...markdownPaths, ...hardcodedPaths];
}

interface Props {
  entry: CollectionEntry<'projects'> | null;
  hardcoded: import('../../data/hardcodedProjects').HardcodedProject | null;
}
const { entry, hardcoded } = Astro.props;
const slug = entry?.slug ?? hardcoded?.slug ?? Astro.params.slug ?? '';
const isMarkdown = entry != null;
const isHardcoded = hardcoded != null;

const projectImages = getProjectImages(slug);
const base = import.meta.env.BASE_URL;
const imgUrl = (filename: string) => `${base}projects/${slug}/${filename}`;

let Content: import('astro').Component | null = null;
let title = '';
let description = '';
let pubDate: Date | null = null;
let tech: string[] = [];
let repo: string | undefined;
let link: string | undefined;

if (isMarkdown && entry) {
  const rendered = await entry.render();
  Content = rendered.Content;
  title = entry.data.title;
  description = entry.data.description;
  pubDate = entry.data.pubDate;
  tech = entry.data.tech ?? [];
  repo = entry.data.repo;
  link = entry.data.link;
} else if (isHardcoded && hardcoded) {
  title = hardcoded.titleEn;
  description = hardcoded.descriptionEn;
  pubDate = new Date(hardcoded.pubDate);
  tech = hardcoded.tech;
  repo = hardcoded.repo;
  link = hardcoded.link;
}
---
<BaseLayout title={title} description={description}>
  <article class="project-detail">
    <header>
      {isMarkdown ? (
        <h1>{title}</h1>
      ) : (
        <>
          <h1 class="content-zh">{hardcoded!.titleZh}</h1>
          <h1 class="content-en">{hardcoded!.titleEn}</h1>
        </>
      )}
      <p class="meta">
        {pubDate && (
          <time datetime={pubDate.toISOString()}>
            {pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
          </time>
        )}
        {tech.length > 0 && (
          <span class="tech"> · {tech.join(', ')}</span>
        )}
      </p>
      {(repo || link) && (
        <p class="links">
          {repo && <a href={repo} target="_blank" rel="noopener noreferrer">Repository</a>}
          {repo && link && ' · '}
          {link && <a href={link} target="_blank" rel="noopener noreferrer">Live demo</a>}
        </p>
      )}
    </header>
    <div class="prose">
      {isMarkdown && Content && <Content />}
      {isHardcoded && hardcoded && (
        <>
          {(hardcoded.bodyZh || hardcoded.bodyEn) && (
            <>
              <h2 class="project-intro-title content-zh" data-i18n="projectIntroTitleZh">简介</h2>
              <h2 class="project-intro-title content-en" data-i18n="projectIntroTitleEn">Introduction</h2>
              {hardcoded.bodyZh && <div class="content-zh project-body" set:html={formatBody(hardcoded.bodyZh)} />}
              {hardcoded.bodyEn && <div class="content-en project-body" set:html={formatBody(hardcoded.bodyEn)} />}
            </>
          )}
        </>
      )}
    </div>
    {isHardcoded && hardcoded?.codeSnippets && hardcoded.codeSnippets.length > 0 && (
      <section class="project-code-section">
        <h2 class="project-code-section-title content-zh" data-i18n="projectCodeTitleZh">核心代码</h2>
        <h2 class="project-code-section-title content-en" data-i18n="projectCodeTitleEn">Core Code</h2>
        <div class="project-code-list">
          {hardcoded.codeSnippets.map((snippet) => (
            <div class="project-code-block">
              <h3 class="project-code-block-title content-zh">{snippet.titleZh}</h3>
              <h3 class="project-code-block-title content-en">{snippet.titleEn}</h3>
              <pre class="project-code-pre"><code class={`language-${snippet.lang}`} set:html={escapeHtml(snippet.code)} /></pre>
            </div>
          ))}
        </div>
      </section>
    )}
    {projectImages.length > 0 && (
      <>
        <section class="project-gallery" aria-label="Project images">
          <h2 class="gallery-title content-zh" data-i18n="projectGalleryTitleZh">展示</h2>
          <h2 class="gallery-title content-en" data-i18n="projectGalleryTitleEn">Showcase</h2>
          <div class="gallery-grid">
            {projectImages.map((filename) => (
              <img class="gallery-zoom-img" src={imgUrl(filename)} data-full-src={imgUrl(filename)} alt="" loading="lazy" title="Double-click to zoom" />
            ))}
          </div>
        </section>
      </>
    )}
    <p class="back-link"><a href="#" role="button" data-back>← <span data-i18n="navBack">返回上一页</span></a></p>
  </article>
</BaseLayout>

<style>
  .project-detail header {
    margin-bottom: 1.5rem;
  }
  .project-detail h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem;
  }
  .meta {
    color: var(--muted);
    font-size: 0.9rem;
    margin: 0 0 0.25rem;
  }
  .links {
    font-size: 0.9rem;
    margin: 0;
  }
  .prose :global(h2) {
    font-size: 1.2rem;
    margin: 1.5rem 0 0.5rem;
  }
  .prose :global(h3) {
    font-size: 1.05rem;
    margin: 1.25rem 0 0.5rem;
  }
  .prose :global(p) {
    margin: 0 0 0.75rem;
    color: var(--muted);
  }
  .prose :global(ul) {
    margin: 0 0 0.75rem;
    padding-left: 1.25rem;
    color: var(--muted);
  }
  .project-intro-title {
    font-size: 1.15rem;
    font-weight: 600;
    margin: 1.25rem 0 0.5rem;
  }
  .project-body :global(p) {
    margin: 0 0 0.75rem;
    color: var(--muted);
  }
  .project-code-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--glass-border);
  }
  .project-code-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 1rem;
  }
  .project-code-list {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  .project-code-block {
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    overflow: hidden;
    background: rgba(22, 27, 34, 0.5);
  }
  .project-code-block-title {
    font-size: 0.95rem;
    font-weight: 600;
    margin: 0;
    padding: 0.5rem 0.75rem;
    background: rgba(255, 255, 255, 0.04);
    border-bottom: 1px solid var(--glass-border);
    color: var(--text);
  }
  .project-code-pre {
    margin: 0;
    padding: 1rem;
    font-size: 0.8rem;
    line-height: 1.5;
    overflow-x: auto;
    color: var(--muted);
  }
  .project-code-pre code {
    font-family: ui-monospace, "Cascadia Code", "Source Code Pro", Menlo, monospace;
    white-space: pre;
  }
  .project-gallery {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--glass-border);
  }
  .gallery-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 1rem;
  }
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 0.75rem;
  }
  .gallery-grid img {
    width: 100%;
    height: auto;
    border-radius: var(--radius);
    object-fit: cover;
    aspect-ratio: 4 / 3;
    border: 1px solid var(--glass-border);
  }
  .back-link {
    margin-top: 1.5rem;
    font-size: 0.9rem;
    color: var(--muted);
  }
</style>
