---
import BaseLayout from '../../layouts/BaseLayout.astro';
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import fs from 'fs';
import path from 'path';
import { hardcodedProjects } from '../../data/hardcodedProjects';
import { createHighlighter } from 'shiki';

const imageExtensions = new Set(['.jpg', '.jpeg', '.png', '.webp', '.gif']);
const videoExtensions = new Set(['.mp4', '.webm', '.mov']);

function getProjectImages(slug: string): string[] {
  const dir = path.join(process.cwd(), 'public', 'projects', slug);
  try {
    if (!fs.existsSync(dir) || !fs.statSync(dir).isDirectory()) return [];
    const files = fs.readdirSync(dir);
    return files
      .filter((f) => imageExtensions.has(path.extname(f).toLowerCase()) && !f.startsWith('.'))
      .sort();
  } catch {
    return [];
  }
}

function getProjectVideos(slug: string): string[] {
  const dir = path.join(process.cwd(), 'public', 'projects', slug);
  try {
    if (!fs.existsSync(dir) || !fs.statSync(dir).isDirectory()) return [];
    const files = fs.readdirSync(dir);
    return files
      .filter((f) => videoExtensions.has(path.extname(f).toLowerCase()) && !f.startsWith('.'))
      .sort();
  } catch {
    return [];
  }
}

function formatBody(text: string): string {
  if (!text.trim()) return '';
  return text
    .trim()
    .split(/\n\n+/)
    .map((p) => `<p>${p.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</p>`)
    .join('');
}

// Shiki highlighter 实例（懒加载）
let highlighterPromise: ReturnType<typeof createHighlighter> | null = null;
async function getHighlighter() {
  if (!highlighterPromise) {
    highlighterPromise = createHighlighter({
      themes: ['github-dark'],
      langs: ['python', 'sql', 'bash', 'json', 'javascript', 'typescript'],
    });
  }
  return highlighterPromise;
}

async function highlightCode(code: string, lang: string): Promise<string> {
  const highlighter = await getHighlighter();
  // 如果语言不支持，回退到纯文本
  const supportedLangs = highlighter.getLoadedLanguages();
  const finalLang = supportedLangs.includes(lang as any) ? lang : 'text';
  return highlighter.codeToHtml(code, { lang: finalLang, theme: 'github-dark' });
}

export async function getStaticPaths() {
  const fromMarkdown = await getCollection('projects');
  const markdownPaths = fromMarkdown.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry, hardcoded: null as null },
  }));
  const hardcodedPaths = hardcodedProjects.map((project) => ({
    params: { slug: project.slug },
    props: { entry: null as null, hardcoded: project },
  }));
  return [...markdownPaths, ...hardcodedPaths];
}

interface Props {
  entry: CollectionEntry<'projects'> | null;
  hardcoded: import('../../data/hardcodedProjects').HardcodedProject | null;
}
const { entry, hardcoded } = Astro.props;
const slug = entry?.slug ?? hardcoded?.slug ?? Astro.params.slug ?? '';
const isMarkdown = entry != null;
const isHardcoded = hardcoded != null;

const projectImages = getProjectImages(slug);
const projectVideos = getProjectVideos(slug);
const base = import.meta.env.BASE_URL;
const imgUrl = (filename: string) => `${base}projects/${slug}/${filename}`;
const videoUrl = (filename: string) => `${base}projects/${slug}/${filename}`;

let Content: import('astro').Component | null = null;
let title = '';
let description = '';
let pubDate: Date | null = null;
let tech: string[] = [];
let repo: string | undefined;
let link: string | undefined;

if (isMarkdown && entry) {
  const rendered = await entry.render();
  Content = rendered.Content;
  title = entry.data.title;
  description = entry.data.description;
  pubDate = entry.data.pubDate;
  tech = entry.data.tech ?? [];
  repo = entry.data.repo;
  link = entry.data.link;
} else if (isHardcoded && hardcoded) {
  title = hardcoded.titleEn;
  description = hardcoded.descriptionEn;
  pubDate = new Date(hardcoded.pubDate);
  tech = hardcoded.tech;
  repo = hardcoded.repo;
  link = hardcoded.link;
}

// 预先高亮所有代码片段
interface HighlightedSnippet {
  titleZh: string;
  titleEn: string;
  highlightedHtml: string;
}
const highlightedSnippets: HighlightedSnippet[] = [];
if (isHardcoded && hardcoded?.codeSnippets) {
  for (const snippet of hardcoded.codeSnippets) {
    const html = await highlightCode(snippet.code, snippet.lang);
    highlightedSnippets.push({
      titleZh: snippet.titleZh,
      titleEn: snippet.titleEn,
      highlightedHtml: html,
    });
  }
}
---
<BaseLayout title={title} description={description}>
  <article class="project-detail">
    <header>
      {isMarkdown ? (
        <h1>{title}</h1>
      ) : (
        <>
          <h1 class="content-zh">{hardcoded!.titleZh}</h1>
          <h1 class="content-en">{hardcoded!.titleEn}</h1>
        </>
      )}
      {tech.length > 0 && (
        <p class="meta">
          <span class="tech">{tech.join(' · ')}</span>
        </p>
      )}
      {(repo || link) && (
        <p class="links">
          {repo && <a href={repo} target="_blank" rel="noopener noreferrer">Repository</a>}
          {repo && link && ' · '}
          {link && <a href={link} target="_blank" rel="noopener noreferrer">Live demo</a>}
        </p>
      )}
    </header>
    <div class="prose">
      {isMarkdown && Content && <Content />}
      {isHardcoded && hardcoded && (
        <>
          {(hardcoded.bodyZh || hardcoded.bodyEn) && (
            <>
              <h2 class="project-intro-title content-zh" data-i18n="projectIntroTitleZh">简介</h2>
              <h2 class="project-intro-title content-en" data-i18n="projectIntroTitleEn">Introduction</h2>
              {hardcoded.bodyZh && <div class="content-zh project-body" set:html={formatBody(hardcoded.bodyZh)} />}
              {hardcoded.bodyEn && <div class="content-en project-body" set:html={formatBody(hardcoded.bodyEn)} />}
            </>
          )}
        </>
      )}
    </div>
    {highlightedSnippets.length > 0 && (
      <section class="project-code-section">
        <h2 class="project-code-section-title content-zh" data-i18n="projectCodeTitleZh">核心代码</h2>
        <h2 class="project-code-section-title content-en" data-i18n="projectCodeTitleEn">Core Code</h2>
        <div class="project-code-list">
          {highlightedSnippets.map((snippet) => (
            <div class="project-code-block">
              <h3 class="project-code-block-title content-zh">{snippet.titleZh}</h3>
              <h3 class="project-code-block-title content-en">{snippet.titleEn}</h3>
              <div class="project-code-pre" set:html={snippet.highlightedHtml} />
            </div>
          ))}
        </div>
      </section>
    )}
    {projectVideos.length > 0 && (
      <section class="project-video-section" aria-label="Project videos">
        <h2 class="gallery-title content-zh">演示视频</h2>
        <h2 class="gallery-title content-en">Demo Video</h2>
        <div class="video-list">
          {projectVideos.map((filename) => (
            <video class="project-video" controls preload="metadata">
              <source src={videoUrl(filename)} type={filename.endsWith('.webm') ? 'video/webm' : filename.endsWith('.mov') ? 'video/quicktime' : 'video/mp4'} />
              Your browser does not support the video tag.
            </video>
          ))}
        </div>
      </section>
    )}
    {projectImages.length > 0 && (
      <>
        <section class="project-gallery" aria-label="Project images">
          <h2 class="gallery-title content-zh" data-i18n="projectGalleryTitleZh">展示</h2>
          <h2 class="gallery-title content-en" data-i18n="projectGalleryTitleEn">Showcase</h2>
          <div class="gallery-grid">
            {projectImages.map((filename) => (
              <img class="gallery-zoom-img" src={imgUrl(filename)} data-full-src={imgUrl(filename)} alt="" loading="lazy" title="Double-click to zoom" />
            ))}
          </div>
        </section>
      </>
    )}
    <p class="back-link"><a href="#" role="button" data-back>← <span data-i18n="navBack">返回上一页</span></a></p>
  </article>
</BaseLayout>

<style>
  .project-detail header {
    margin-bottom: 1.5rem;
  }
  .project-detail h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem;
  }
  .meta {
    color: var(--muted);
    font-size: 0.9rem;
    margin: 0 0 0.25rem;
  }
  .links {
    font-size: 0.9rem;
    margin: 0;
  }
  .prose :global(h2) {
    font-size: 1.2rem;
    margin: 1.5rem 0 0.5rem;
  }
  .prose :global(h3) {
    font-size: 1.05rem;
    margin: 1.25rem 0 0.5rem;
  }
  .prose :global(p) {
    margin: 0 0 0.75rem;
    color: var(--muted);
  }
  .prose :global(ul) {
    margin: 0 0 0.75rem;
    padding-left: 1.25rem;
    color: var(--muted);
  }
  .project-intro-title {
    font-size: 1.15rem;
    font-weight: 600;
    margin: 1.25rem 0 0.5rem;
  }
  .project-body :global(p) {
    margin: 0 0 0.75rem;
    color: var(--muted);
  }
  .project-code-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--glass-border);
  }
  .project-code-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 1rem;
  }
  .project-code-list {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  .project-code-block {
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    overflow: hidden;
    background: rgba(22, 27, 34, 0.5);
  }
  .project-code-block-title {
    font-size: 0.95rem;
    font-weight: 600;
    margin: 0;
    padding: 0.5rem 0.75rem;
    background: rgba(255, 255, 255, 0.04);
    border-bottom: 1px solid var(--glass-border);
    color: var(--text);
  }
  .project-code-pre {
    margin: 0;
    font-size: 0.8rem;
    line-height: 1.5;
    overflow-x: auto;
  }
  .project-code-pre :global(pre) {
    margin: 0;
    padding: 1rem;
    border-radius: 0;
    overflow-x: auto;
  }
  .project-code-pre :global(code) {
    font-family: ui-monospace, "Cascadia Code", "Source Code Pro", Menlo, monospace;
    font-size: 0.8rem;
    line-height: 1.5;
  }
  .project-video-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--glass-border);
  }
  .video-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .project-video {
    width: 100%;
    max-width: 100%;
    border-radius: var(--radius);
    border: 1px solid var(--glass-border);
    background: rgba(0, 0, 0, 0.3);
  }
  .project-gallery {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--glass-border);
  }
  .gallery-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 1rem;
  }
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 0.75rem;
  }
  .gallery-grid img {
    width: 100%;
    height: auto;
    border-radius: var(--radius);
    object-fit: cover;
    aspect-ratio: 4 / 3;
    border: 1px solid var(--glass-border);
  }
  .back-link {
    margin-top: 1.5rem;
    font-size: 0.9rem;
    color: var(--muted);
  }
</style>
