---
import ProfileSidebar from '../components/ProfileSidebar.astro';
import Analytics from '../components/Analytics.astro';
interface Props {
  title: string;
  description?: string;
  /** 是否显示左侧个人信息栏，设为 false 时（如「其他」页）不显示 */
  showSidebar?: boolean;
  /** 主内容区额外 class，如 xian-detail 用于放宽宽度 */
  contentClass?: string;
}
const { title, description = 'Zhuoheng Li - MS in Management & Analytics @ NYU | Data Analytics & Data Engineering', showSidebar = true, contentClass } = Astro.props;
const base = import.meta.env.BASE_URL;
---
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title}</title>
    <script is:inline>
      /* 进站首屏与首次点击后跳转页需共用同一 session id，仅 sessionStorage 在部分场景下跳转后不可用，用 cookie 兜底 */
      (function(){
        var p = typeof location !== 'undefined' ? (location.pathname || '') : '';
        if (p.indexOf('/manage') !== -1) return;
        var key = 'ah_sid';
        function fromCookie() {
          try { var c = document.cookie.split(';'); for (var i = 0; i < c.length; i++) { var t = c[i].trim(); if (t.indexOf(key + '=') === 0) return t.slice(key.length + 1); } } catch(e) {}
          return null;
        }
        function setBoth(u) {
          try { sessionStorage.setItem(key, u); } catch(e) {}
          try { document.cookie = key + '=' + u + '; path=/; max-age=86400; SameSite=Lax'; } catch(e) {}
        }
        try {
          var v = sessionStorage.getItem(key) || fromCookie();
          if (!v) { v = typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0;return (c==='x'?r:(r&3|8)).toString(16);}); }
          setBoth(v);
        } catch(e) {}
      })();
    </script>
    <link rel="icon" type="image/svg+xml" href={`${base}favicon.svg`} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&family=Noto+Serif+SC:wght@400;600;700&family=Source+Sans+3:ital,wght@0,400;0,600;0,700;1,400&family=Dancing+Script:wght@400;600;700&family=ZCOOL+XiaoWei&display=swap"
      rel="stylesheet"
    />
    <style is:global>
      :root {
        --bg: #0f1218;
        --surface: #161b22;
        --text: #f0f4f8;
        --muted: #a8b4c0;
        --accent: #3fb950;
        --accent-hover: #56d364;
        --border: #30363d;
        --space: 1.5rem;
        --space-lg: 3rem;
        --radius: 10px;
        /* 玻璃质感 */
        --glass-bg: rgba(22, 27, 34, 0.35);
        --glass-border: rgba(255, 255, 255, 0.08);
        --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.06);
        --glass-blur: 14px;
        /* 布局尺寸 */
        --layout-max-width: 900px;
        --sidebar-width: 220px;
        --content-width: 600px;
        --layout-gap: 32px;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      html {
        scroll-behavior: smooth;
      }
      html[lang="en"] .content-zh {
        display: none !important;
      }
      html[lang="zh-CN"] .content-en {
        display: none !important;
      }
      /* 中文版：正文 Noto Sans SC，标题 Noto Serif SC */
      html[lang="zh-CN"] {
        --font-sans: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
        --font-serif: "Noto Serif SC", "Source Han Serif SC", serif;
      }
      /* 英文版：统一 Source Sans 3 */
      html[lang="en"] {
        --font-sans: "Source Sans 3", system-ui, -apple-system, sans-serif;
        --font-serif: "Source Sans 3", system-ui, -apple-system, sans-serif;
      }
      body {
        margin: 0;
        font-family: var(--font-sans);
        font-size: 1rem;
        line-height: 1.65;
        color: var(--text);
        background: var(--bg);
        -webkit-font-smoothing: antialiased;
        position: relative;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .site-bg {
        position: fixed;
        inset: 0;
        z-index: 0;
        overflow: hidden;
        background: var(--bg);
      }
      .site-bg-image {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }
      .site-bg-overlay {
        position: absolute;
        inset: 0;
        background: rgba(10, 12, 16, 0.35);
        pointer-events: none;
      }
      .site-header,
      .main,
      .main-with-sidebar,
      .site-footer {
        position: relative;
        z-index: 1;
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      pre {
        background: var(--glass-bg);
        backdrop-filter: blur(var(--glass-blur));
        -webkit-backdrop-filter: blur(var(--glass-blur));
        border: 1px solid var(--glass-border);
        box-shadow: var(--glass-shadow);
        border-radius: var(--radius);
        padding: 1rem 1.25rem;
        overflow-x: auto;
        font-size: 0.9rem;
      }
      code {
        font-family: ui-monospace, monospace;
        font-size: 0.9em;
      }
      /* 流体光标效果 */
      .fluid-canvas {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none;
      }
      /* 全站 lightbox：挂 body 下、最高 z-index，避免被导航/侧栏/iframe 遮挡 */
      .global-lightbox {
        position: fixed;
        inset: 0;
        z-index: 2147483647;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        box-sizing: border-box;
        isolation: isolate;
      }
      .global-lightbox[hidden] {
        display: none !important;
      }
      .global-lightbox-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        cursor: pointer;
      }
      .global-lightbox-img {
        position: relative;
        z-index: 1;
        max-width: 95vw;
        max-height: 90vh;
        width: auto;
        height: auto;
        object-fit: contain;
        border-radius: var(--radius);
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
        pointer-events: none;
      }
      .global-lightbox-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 2;
        width: 2.5rem;
        height: 2.5rem;
        border: none;
        border-radius: 50%;
        background: var(--glass-bg);
        color: var(--text);
        font-size: 1.5rem;
        line-height: 1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      .global-lightbox-close:hover {
        background: var(--muted);
      }
      .gallery-zoom-img,
      .photo-zoom-img {
        cursor: zoom-in;
      }
    </style>
  </head>
  <body>
    <Analytics supabaseUrl={import.meta.env.PUBLIC_SUPABASE_URL} supabaseKey={import.meta.env.PUBLIC_SUPABASE_ANON_KEY} />
    <!-- 流体光标效果 canvas -->
    <canvas class="fluid-canvas" aria-hidden="true"></canvas>
    <div class="site-bg" aria-hidden="true">
      <div class="site-bg-image" style={`background-image: url('${base}background/F4467B54-CFF9-4477-8126-FAA472AB0E39.jpeg');`}></div>
      <div class="site-bg-overlay"></div>
    </div>
    <header class="site-header">
      <nav class="nav">
        <button type="button" class="nav-close" aria-label="关闭菜单"><span class="content-zh">关闭</span><span class="content-en">Close</span></button>
        <ul class="nav-links">
          <li><a href={base} class="nav-home" data-i18n="navHome">首页</a></li>
          <li><a href={`${base}experience/`} data-i18n="navExperience">工作</a></li>
          <li><a href={`${base}projects/`} data-i18n="navProjects">项目</a></li>
          <li><a href={`${base}education/`} data-i18n="navEducation">教育</a></li>
          <li><a href={`${base}contact/`} data-i18n="navContact">联系</a></li>
          <li><a href={`${base}guestbook/`} data-i18n="navGuestbook">留言</a></li>
          <li class="nav-dropdown">
            <span class="nav-dropdown-trigger" aria-haspopup="true" aria-expanded="false" data-i18n="navOthers">其他</span>
            <ul class="nav-dropdown-menu" role="menu">
              <li role="none"><a href={`${base}photography/`} role="menuitem" data-i18n="sectionPhotography">摄影</a></li>
              <li role="none"><a href={`${base}blog/`} role="menuitem" data-i18n="sectionBlog">博客</a></li>
              <li role="none"><a href={`${base}playground/`} role="menuitem" data-i18n="sectionPlayground">游乐场</a></li>
            </ul>
          </li>
          <li><a href={`${base}resume/`} data-i18n="navResume">简历</a></li>
        </ul>
        <div class="nav-lang">
          <button type="button" id="lang-zh" class="lang-btn active" aria-label="中文">中文</button>
          <span class="lang-divider">/</span>
          <button type="button" id="lang-en" class="lang-btn" aria-label="English">EN</button>
        </div>
        <button class="nav-toggle" aria-label="打开菜单" data-i18n-aria="navMenuAria">
          <span></span><span></span><span></span>
        </button>
      </nav>
    </header>
    <main class={showSidebar ? "main-with-sidebar" : "main"}>
      {showSidebar && <ProfileSidebar avatarSrc="avatar.jpg" />}
      <div class={[showSidebar ? "main-content" : "main-inner", contentClass].filter(Boolean).join(" ")}>
        <slot />
      </div>
    </main>
    <footer class="site-footer">
      <p>© <span id="year"></span> <span class="content-zh">李卓衡</span><span class="content-en">Zhuoheng Li</span> · <span class="content-zh" data-i18n="footerSiteZh">个人网站</span><span class="content-en" data-i18n="footerSiteEn">Personal Site</span></p>
    </footer>
    <!-- 全站共用 lightbox，挂到 body 下避免被遮挡 -->
    <div class="global-lightbox" id="global-lightbox" role="dialog" aria-modal="true" aria-label="Zoomed image" hidden>
      <div class="global-lightbox-backdrop"></div>
      <img class="global-lightbox-img" src="" alt="" />
      <button type="button" class="global-lightbox-close" aria-label="Close">×</button>
    </div>
    <script is:inline src={`${base}js/i18n.js`}></script>
    <script is:inline src={`${base}js/main.js`}></script>
    <script is:inline>
      (function () {
        var lb = document.getElementById('global-lightbox');
        var lbImg = lb && lb.querySelector('.global-lightbox-img');
        var backdrop = lb && lb.querySelector('.global-lightbox-backdrop');
        var closeBtn = lb && lb.querySelector('.global-lightbox-close');
        function openLightbox(src) {
          if (!lb || !lbImg) return;
          lbImg.src = src;
          lb.hidden = false;
          document.body.style.overflow = 'hidden';
        }
        function closeLightbox() {
          if (!lb) return;
          lb.hidden = true;
          document.body.style.overflow = '';
        }
        function bindZoomImages() {
          document.querySelectorAll('.gallery-zoom-img, .photo-zoom-img').forEach(function (img) {
            if (img.dataset.zoomBound) return;
            img.dataset.zoomBound = '1';
            img.addEventListener('dblclick', function () {
              var src = img.dataset.fullSrc || img.currentSrc || img.src;
              openLightbox(src);
            });
          });
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', bindZoomImages);
        } else {
          bindZoomImages();
        }
        backdrop && backdrop.addEventListener('click', closeLightbox);
        closeBtn && closeBtn.addEventListener('click', closeLightbox);
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape' && lb && !lb.hidden) closeLightbox();
        });
      })();
    </script>
    <!-- fluid-cursor 在部分环境会触发 WebGL uniform/program 报错，暂时禁用；需要时可恢复 -->
    <!-- <script is:inline src={`${base}js/fluid-cursor.js`}></script> -->
  </body>
</html>

<style>
  .site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border-bottom: 1px solid var(--glass-border);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.04);
    padding: var(--space) var(--space-lg);
  }
  .nav {
    position: relative;
    max-width: 720px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
  }
  .nav-home {
    font-family: inherit;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
  }
  .nav-home:hover {
    text-decoration: none;
    color: var(--accent);
  }
  .nav-links {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-wrap: nowrap;
    gap: 0.9rem;
    align-items: center;
  }
  .nav-links a {
    color: var(--muted);
    font-weight: 500;
    font-size: 0.875rem;
    white-space: nowrap;
  }
  .nav-links a:hover {
    color: var(--text);
    text-decoration: none;
  }
  .nav-dropdown {
    position: relative;
  }
  .nav-dropdown-trigger {
    color: var(--muted);
    font-weight: 500;
    font-size: 0.875rem;
    font-family: inherit;
    cursor: default;
    padding: 0;
    background: none;
    border: none;
    white-space: nowrap;
  }
  .nav-dropdown:hover .nav-dropdown-trigger {
    color: var(--text);
  }
  .nav-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    margin: 0.25rem 0 0;
    padding: 0.5rem 0;
    min-width: 10rem;
    list-style: none;
    background: rgba(22, 27, 34, 0.95);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    box-shadow: var(--glass-shadow);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.15s ease, visibility 0.15s ease;
    z-index: 50;
  }
  .nav-dropdown:hover .nav-dropdown-menu {
    opacity: 1;
    visibility: visible;
  }
  .nav-dropdown-menu li {
    margin: 0;
  }
  .nav-dropdown-menu a {
    display: block;
    padding: 0.4rem 1rem;
    color: var(--muted);
    font-weight: 500;
    font-size: 0.9rem;
  }
  .nav-dropdown-menu a:hover {
    color: var(--text);
    background: rgba(255, 255, 255, 0.05);
    text-decoration: none;
  }
  .nav-lang {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    white-space: nowrap;
  }
  .lang-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--muted);
    background: none;
    border: none;
    cursor: pointer;
    border-radius: 4px;
    white-space: nowrap;
  }
  .lang-btn:hover {
    color: var(--text);
  }
  .lang-btn.active {
    color: var(--accent);
    font-weight: 600;
  }
  .lang-divider {
    color: var(--border);
    user-select: none;
  }
  .nav-close {
    display: none;
  }
  .nav-toggle {
    display: none;
    flex-direction: column;
    gap: 5px;
    padding: 8px;
    background: none;
    border: none;
    cursor: pointer;
  }
  .nav-toggle span {
    width: 20px;
    height: 2px;
    background: var(--text);
    border-radius: 1px;
  }
  .main {
    max-width: 720px;
    margin: 0 auto;
    padding: 0 1.5rem 2rem;
    min-height: 60vh;
    flex: 1;
  }
  .main-with-sidebar {
    width: 100%;
    max-width: var(--layout-max-width);
    margin: 0 auto;
    padding: 0 1.5rem 2rem;
    padding-left: calc(var(--sidebar-width) + var(--layout-gap) + 1.5rem);
    min-height: 60vh;
    flex: 1;
  }
  .main-inner,
  .main-content {
    min-width: 0;
  }
  .main .main-inner {
    max-width: 720px;
    margin: 0 auto;
  }
  .main-with-sidebar .main-content {
    width: var(--content-width) !important;
    min-width: var(--content-width) !important;
    max-width: var(--content-width) !important;
  }
  @media (max-width: 991px) {
    .main-with-sidebar {
      padding-left: 1.5rem;
    }
    .main-with-sidebar .main-content {
      width: 100% !important;
      min-width: 0 !important;
      max-width: 100% !important;
    }
  }
  .site-footer {
    text-align: center;
    padding: var(--space-lg) 1.5rem;
    color: var(--muted);
    font-size: 0.875rem;
    border-top: 1px solid var(--glass-border);
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    position: relative;
    z-index: 1;
  }
  @media (max-width: 920px) {
    .nav-links {
      display: none;
    }
    .nav.open .nav-links {
      display: flex !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      min-height: 100vh !important;
      min-height: 100dvh !important;
      flex-direction: column !important;
      padding: 5rem 1.5rem 2rem !important;
      margin: 0 !important;
      background: rgba(20, 25, 34, 0.88) !important;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: none;
      gap: 0.5rem;
      z-index: 9998 !important;
      overflow-y: auto !important;
      align-items: stretch !important;
      -webkit-overflow-scrolling: touch;
    }
    .nav.open .nav-links li {
      display: block !important;
      margin: 0 !important;
      visibility: visible !important;
    }
    .nav.open .nav-links li:first-child a {
      padding: 0.75rem 1rem;
    }
    .nav.open .nav-links a {
      display: block !important;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border-radius: var(--radius);
      color: var(--text) !important;
    }
    .nav.open .nav-links .nav-dropdown {
      display: flex !important;
      flex-direction: column;
      align-items: stretch;
    }
    .nav.open .nav-links .nav-dropdown .nav-dropdown-trigger {
      display: block;
      padding: 0.75rem 1rem;
      color: var(--text);
      font-size: 1rem;
    }
    .nav.open .nav-links .nav-dropdown-menu {
      display: none !important;
      margin: 0.25rem 0 0 0 !important;
      padding: 0.25rem 0 !important;
      border: none;
      box-shadow: none;
      background: rgba(0, 0, 0, 0.25);
      border-radius: var(--radius);
      list-style: none;
    }
    .nav.open .nav-links .nav-dropdown.dropdown-open .nav-dropdown-menu {
      display: block !important;
      position: static !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
    .nav.open .nav-links .nav-dropdown-menu li {
      margin: 0;
    }
    .nav.open .nav-links .nav-dropdown-menu a {
      display: block !important;
      padding: 0.6rem 1rem !important;
      font-size: 0.95rem !important;
      color: var(--text) !important;
      border-radius: calc(var(--radius) - 2px);
    }
    .nav.open .nav-links .nav-dropdown-menu a:hover {
      background: rgba(255, 255, 255, 0.06);
    }
    .nav.open .nav-links .nav-dropdown .nav-dropdown-trigger {
      cursor: pointer;
      user-select: none;
    }
    .nav-dropdown {
      flex-direction: column;
      align-items: stretch;
    }
    .nav-dropdown-menu {
      position: static;
      opacity: 1;
      visibility: visible;
      margin: 0.35rem 0 0 1rem;
      padding: 0.35rem 0;
      border: none;
      box-shadow: none;
      background: transparent;
    }
    .nav-dropdown-menu a {
      padding: 0.3rem 0;
    }
    .nav-toggle {
      display: flex;
      position: relative;
      z-index: 101;
    }
    .nav.open .nav-toggle,
    .nav.open .nav-lang {
      display: none !important;
    }
    .nav.open .nav-close {
      display: block !important;
      position: fixed !important;
      top: 1rem !important;
      right: 1rem !important;
      left: auto !important;
      z-index: 9999 !important;
      padding: 0.6rem 1.2rem !important;
      font-size: 1rem !important;
      color: var(--text) !important;
      background: rgba(22, 27, 34, 0.9) !important;
      border: 1px solid var(--glass-border) !important;
      border-radius: var(--radius) !important;
      cursor: pointer !important;
    }
  }
</style>
